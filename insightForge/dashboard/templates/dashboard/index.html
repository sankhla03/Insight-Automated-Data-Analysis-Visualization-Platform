{% extends "dashboard/base.html" %}
{% block content %}
<div class="container">
  <h2>InsightForge - Advanced Data Analysis Platform</h2>
  
  <!-- Data Upload Section -->
  <div class="card">
    <h3>ğŸ“Š Data Upload & Processing</h3>
    <form method="post" enctype="multipart/form-data" id="upload-form">
      {% csrf_token %}
      <input type="hidden" name="upload_data" value="1">
      
      <div class="grid grid-2">
        <div>
          <label class="file-upload">
            <input type="file" name="file" accept=".csv,.xlsx,.xls,.json">
            <span class="file-upload-label">ğŸ“ Click to select a file or drag and drop</span>
          </label>
        </div>
        <div>
          <label>
            <input type="checkbox" name="use_sample" value="1">
            Use Sample Dataset
          </label>
        </div>
      </div>
      
      <div class="grid grid-2">
        <label>
          <input type="checkbox" name="do_transform" value="1">
          Convert categorical to numeric (Label Encoding)
        </label>
      </div>
      

      
      <button type="submit" onclick="return validateForm('upload-form')">ğŸš€ Process Data</button>
    </form>
  </div>

  <!-- Data Summary -->
  {% if data_summary %}
  <div class="card">
    <h3>ğŸ“ˆ Data Summary</h3>
    <div class="grid grid-2">
      <div>
        <p><strong>Original Rows:</strong> {{ data_summary.original_rows }}</p>
        <p><strong>Original Columns:</strong> {{ data_summary.original_columns }}</p>
        <p><strong>Cleaned Rows:</strong> {{ data_summary.cleaned_rows }}</p>
      </div>
      <div>
        <p><strong>Duplicates Removed:</strong> {{ data_summary.duplicates_removed }}</p>
        <p><strong>Missing Values Filled:</strong> {{ data_summary.missing_values_filled }}</p>
        <p><strong>Final Columns:</strong> {{ data_summary.final_columns|length }}</p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Complete Cleaned Data -->
  {% if data_preview %}
  <div class="card">
    <h3>ğŸ“‹ Complete Cleaned Data ({{ total_rows }} rows)</h3>
    <div class="download-section">
      <a href="{% url 'dashboard:download' %}" class="download-button">
        ğŸ“¥ Download Cleaned CSV
      </a>
    </div>
    
    <!-- Column Dropping Section -->
    <div class="column-drop-section">
      <h4>ğŸ—‘ï¸ Drop Columns</h4>
      <form id="column-drop-form">
        {% csrf_token %}
        <div class="column-selection">
          <label>Select columns to drop:</label>
          <div class="checkbox-grid" id="columns-checkbox-grid">
            {% for col in columns %}
              {% if not col|slice:":8" == "Unnamed:" %}
              <label class="column-checkbox">
                <input type="checkbox" name="columns_to_drop" value="{{ col }}">
                {{ col }}
              </label>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        <div class="drop-controls">
          <div id="drop-loading" style="display: none;">
            <p>ğŸ”„ Updating dataset...</p>
          </div>
          <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">
            ğŸ’¡ <strong>Tip:</strong> Check/uncheck columns below to instantly drop them from your dataset
          </p>
        </div>
      </form>
    </div>
    
    <div class="table-container" id="cleaned-data-table">
      {{ data_preview|safe }}
    </div>
  </div>
  {% endif %}

  <!-- Categorical Mapping -->
  {% if mapping %}
  <div class="card">
    <h3>ğŸ”„ Categorical to Numeric Mapping</h3>
    {% for col, mp in mapping.items %}
    <details>
      <summary>{{ col }}</summary>
      <ul>
        {% for k, v in mp.items %}
        <li>{{ k }} â†’ {{ v }}</li>
        {% endfor %}
      </ul>
    </details>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Visualization Section -->
  {% if columns %}
  <div class="card">
    <h3>ğŸ“Š Advanced Visualizations</h3>
    <form method="post" id="visualization-form-ajax">
      {% csrf_token %}

      <div class="grid grid-2">
        <div>
          <label>Chart Type:</label>
          <select name="chart_type" id="chart-type-select" required>
            <option value="">Select chart type</option>
            <option value="histogram">ğŸ“Š Histogram</option>
            <option value="box">ğŸ“¦ Box Plot</option>
            <option value="pie">ğŸ¥§ Pie Chart</option>
            <option value="line">ğŸ“ˆ Line Chart</option>
            <option value="map">ğŸ—ºï¸ Map Chart</option>
          </select>
        </div>
        <div>
          <label>X-axis Column:</label>
          <select name="x_column" id="x-column-select">
            <option value="">Auto-select</option>
            {% for col in columns %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="grid grid-2">
        <div>
          <label>Y-axis Column:</label>
          <select name="y_column" id="y-column-select">
            <option value="">Auto-select</option>
            {% for col in columns %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label id="color-label">Color Column:</label>
          <select name="color_column" id="color-column-select">
            <option value="">None</option>
            {% for col in columns %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div id="chart-loading" style="display: none;">
        <p>ğŸ”„ Creating visualization...</p>
      </div>
    </form>
  </div>
  {% endif %}

  <!-- Correlation Analysis -->
  {% if numeric_columns and numeric_columns|length > 1 %}
  <div class="card">
    <h3>ğŸ”— Correlation Analysis</h3>
    <form method="post" id="correlation-form">
      {% csrf_token %}
      <input type="hidden" name="correlation_analysis" value="1">
      
      <div class="grid grid-2">
        <div>
          <label>Correlation Method:</label>
          <select name="method">
            <option value="pearson">Pearson</option>
            <option value="spearman">Spearman</option>
            <option value="kendall">Kendall</option>
          </select>
        </div>
        <div>
          <label>Select Numeric Columns:</label>
          <div class="checkbox-grid">
            {% for col in numeric_columns %}
            <label>
              <input type="checkbox" name="numeric_columns" value="{{ col }}" checked>
              {{ col }}
            </label>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <button type="submit">ğŸ”— Analyze Correlations</button>
    </form>
  </div>
  {% endif %}

  <!-- Machine Learning -->
  {% if numeric_columns and numeric_columns|length > 1 %}
  <div class="card">
    <h3>ğŸ¤– Machine Learning</h3>
    <form method="post" id="ml-form">
      {% csrf_token %}
      <input type="hidden" name="ml_analysis" value="1">
      
      <div class="grid grid-2">
        <div>
          <label>Target Column:</label>
          <select name="target_column" required>
            {% for col in columns %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Test Size (%):</label>
          <input type="number" name="test_size" value="20" min="10" max="50">
        </div>
      </div>
      
      <div>
        <label>Feature Columns:</label>
        <div class="checkbox-grid">
          {% for col in columns %}
          <label>
            <input type="checkbox" name="feature_columns" value="{{ col }}">
            {{ col }}
          </label>
          {% endfor %}
        </div>
      </div>
      
      <button type="submit">ğŸš€ Run ML Analysis</button>
    </form>
  </div>
  {% endif %}

  <!-- AI Insights -->
  {% if numeric_columns %}
  <div class="card">
    <h3>ğŸ§  AI Insights</h3>
    <form method="post" id="ai-form">
      {% csrf_token %}
      <input type="hidden" name="ai_insights" value="1">
      
      <div class="grid grid-2">
        <div>
          <label>Date Column (for trend analysis):</label>
          <select name="date_column">
            <option value="">None</option>
            {% for col in date_columns %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Anomaly Threshold (Z-score):</label>
          <input type="number" name="anomaly_threshold" value="2.0" min="1.0" max="5.0" step="0.1">
        </div>
      </div>
      
      <button type="submit">ğŸ§  Generate AI Insights</button>
    </form>
  </div>
  {% endif %}

  <!-- 3D Sculpture -->
  {% if numeric_columns %}
  <div class="card">
    <h3>ğŸ¨ 3D Data Sculpture</h3>
    <form method="post" id="sculpture-form">
      {% csrf_token %}
      <input type="hidden" name="3d_sculpture" value="1">
      
      <div class="grid grid-2">
        <div>
          <label>Numeric Column:</label>
          <select name="3d_column" required>
            {% for col in numeric_columns %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Resolution:</label>
          <select name="3d_resolution">
            <option value="30">30x30 (Fast)</option>
            <option value="50" selected>50x50 (Medium)</option>
            <option value="80">80x80 (High)</option>
          </select>
        </div>
      </div>
      
      <button type="submit">ğŸ¨ Create 3D Sculpture</button>
    </form>
  </div>
  {% endif %}

  <!-- Funding Analysis -->
  <div class="card">
    <h3>ğŸ’° Funding Analysis</h3>
    <form method="post" id="funding-form">
      {% csrf_token %}
      <input type="hidden" name="funding_analysis" value="1">
      <button type="submit">ğŸ’° Analyze Funding Breakdown</button>
    </form>
  </div>

  <!-- Results Display -->
  {% if chart_html %}
  <div class="card">
    <h3>ğŸ“Š Visualization Result</h3>
    <div class="chart-container">
      {{ chart_html.div|safe }}
      {{ chart_html.script|safe }}
    </div>
  </div>
  {% endif %}

  {% if chart_3d_html %}
  <div class="card">
    <h3>ğŸ¨ 3D Sculpture Result</h3>
    <div class="chart-container">
      {{ chart_3d_html|safe }}
    </div>
    {% if stl_download %}
    <p><a href="{{ stl_download }}" download="data_sculpture.stl">ğŸ“¥ Download STL File</a></p>
    {% endif %}
  </div>
  {% endif %}

  {% if correlation_image %}
  <div class="card">
    <h3>ğŸ”— Correlation Heatmap</h3>
    <img src="{{ correlation_image }}" alt="Correlation Heatmap" style="max-width: 100%;">
    {% if correlation_table %}
    <h4>Correlation Matrix</h4>
    {{ correlation_table|safe }}
    {% endif %}
  </div>
  {% endif %}

  {% if ml_results %}
  <div class="card">
    <h3>ğŸ¤– ML Analysis Results</h3>
    {% if ml_results.model_type == 'regression' %}
      <h4>Regression Model Performance</h4>
      <ul>
        <li><strong>MSE:</strong> {{ ml_results.mse|floatformat:4 }}</li>
        <li><strong>RMSE:</strong> {{ ml_results.rmse|floatformat:4 }}</li>
        <li><strong>RÂ² Score:</strong> {{ ml_results.r2_score|floatformat:4 }}</li>
      </ul>
    {% else %}
      <h4>Classification Model Performance</h4>
      <p><strong>Accuracy:</strong> {{ ml_results.accuracy|floatformat:4 }}</p>
      <img src="data:image/png;base64,{{ ml_results.confusion_matrix_image }}" alt="Confusion Matrix" style="max-width: 100%;">
    {% endif %}
  </div>
  {% endif %}

  {% if ai_insights %}
  <div class="card">
    <h3>ğŸ§  AI Insights</h3>
    {% if ai_insights.anomaly_detection %}
      <h4>Anomaly Detection</h4>
      <ul>
        {% for col, data in ai_insights.anomaly_detection.items %}
        <li><strong>{{ col }}:</strong> {{ data.count }} anomalies ({{ data.percentage|floatformat:1 }}%)</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No anomalies detected.</p>
    {% endif %}
    
    {% if ai_insights.trend_analysis %}
      <h4>Trend Analysis</h4>
      <ul>
        {% for trend in ai_insights.trend_analysis %}
        <li><strong>{{ trend.column }}:</strong> {{ trend.trend }} (correlation: {{ trend.correlation_with_time|floatformat:3 }})</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
  {% endif %}

  {% if funding_breakdown %}
  <div class="card">
    <h3>ğŸ’° Funding Breakdown</h3>
    {% for funding_type, data in funding_breakdown.items %}
    <details>
      <summary>{{ funding_type }} ({{ data.count }} records)</summary>
      {{ data.summary|safe }}
    </details>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Feedback Section -->
  <div class="card">
    <h3>ğŸ’¬ Feedback</h3>
    <form method="post" id="feedback-form">
      {% csrf_token %}
      <input type="hidden" name="submit_feedback" value="1">
      {{ feedback_form.as_p }}
      <button type="submit">ğŸ“ Submit Feedback</button>
    </form>
  </div>

  <!-- Report Generation -->
  <div class="card">
    <h3>ğŸ“„ Report Generation</h3>
    <div class="grid grid-2">
      <a href="{% url 'dashboard:report' %}" class="button">ğŸ“Š View Report</a>
      <a href="{% url 'dashboard:report' %}?download=1" class="button">ğŸ“¥ Download Report</a>
    </div>
  </div>
</div>

<style>
.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--border-color);
  padding: 12px;
  border-radius: 6px;
}

.button {
  display: inline-block;
  background: var(--accent-color);
  color: var(--header-text);
  padding: 12px 24px;
  text-decoration: none;
  border-radius: 6px;
  text-align: center;
  transition: all 0.3s ease;
}

.button:hover {
  background: var(--accent-hover);
  transform: translateY(-1px);
}

.download-section {
  margin-bottom: 20px;
  text-align: right;
}

.download-button {
  display: inline-block;
  background: #28a745;
  color: white;
  padding: 12px 24px;
  text-decoration: none;
  border-radius: 6px;
  text-align: center;
  transition: all 0.3s ease;
  font-weight: bold;
}

.download-button:hover {
  background: #218838;
  transform: translateY(-1px);
  color: white;
}

.table-container {
  max-height: 600px;
  overflow: auto;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  margin-top: 15px;
}

.table-container table {
  width: 100%;
  margin: 0;
}

.column-drop-section {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
}

.column-selection {
  margin-bottom: 15px;
}

.column-checkbox {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  margin: 4px 0;
  transition: all 0.2s ease;
}

.column-checkbox:hover {
  background: #e9ecef;
  border-color: #adb5bd;
}

.column-checkbox input[type="checkbox"] {
  margin-right: 10px;
  transform: scale(1.2);
}

.drop-controls {
  display: flex;
  align-items: center;
  gap: 15px;
}

.drop-button {
  background: #dc3545;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}

.drop-button:hover {
  background: #c82333;
  transform: translateY(-1px);
}

.drop-button:disabled {
  background: #6c757d;
  cursor: not-allowed;
  transform: none;
}

.drop-success {
  border-left: 4px solid #28a745;
  background: #f8fff9;
}

.drop-error {
  border-left: 4px solid #dc3545;
  background: #fff8f8;
}

#chart-container {
  min-height: 400px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  margin: 20px 0;
  background: white;
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.chart-container {
  min-height: 400px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  margin: 20px 0;
  background: white;
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.chart-success {
  border-left: 4px solid #28a745;
  background: #f8fff9;
}

.chart-error {
  border-left: 4px solid #dc3545;
  background: #fff8f8;
}

/* Ensure Plotly charts are visible */
.js-plotly-plot {
  background: white !important;
}

/* Fix for Plotly chart containers */
.plotly-graph-div {
  background: white !important;
  min-height: 350px !important;
}

.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid var(--accent-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Disabled select styling for chart UI */
select:disabled {
  background-color: #f8f9fa;
  color: #6c757d;
  cursor: not-allowed;
  opacity: 0.6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // AJAX column dropping functionality
    const dropLoading = document.getElementById('drop-loading');
    const cleanedDataTable = document.getElementById('cleaned-data-table');
    const columnsCheckboxGrid = document.getElementById('columns-checkbox-grid');
    
    // Function to drop columns via AJAX (instant dropping)
    function dropColumns(selectedColumns) {
        if (selectedColumns.length === 0) {
            return; // No columns to drop
        }
        
        console.log('Dropping columns:', selectedColumns); // Debug log
        
        // Show loading
        showDropLoading(true);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        if (!csrfToken) {
            showDropLoading(false);
            showDropMessage('Error: CSRF token not found', 'error');
            return;
        }
        
        // Create form data
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        selectedColumns.forEach(col => formData.append('columns_to_drop', col));
        
        console.log('Making AJAX request to drop columns'); // Debug log
        
        // Make AJAX request
        fetch('/ajax/drop-columns/', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status); // Debug log
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('AJAX response:', data); // Debug log
            showDropLoading(false);
            
            if (data.success) {
                // Update table HTML
                if (data.table_html) {
                    cleanedDataTable.innerHTML = data.table_html;
                }
                
                // Update column checkboxes
                if (data.remaining_columns) {
                    updateColumnCheckboxes(data.remaining_columns);
                }
                
                // Update row count in header
                if (data.total_rows) {
                    updateRowCount(data.total_rows);
                }
                
                // Update visualization dropdowns with current columns
                if (data.remaining_columns) {
                    updateVisualizationDropdowns(data.remaining_columns, data.numeric_columns || []);
                    updateOtherSections(data.remaining_columns, data.numeric_columns || []);
                }
                
                // Show success message
                showDropMessage(data.message || 'Columns dropped successfully!', 'success');
                
            } else {
                showDropMessage(data.error || 'Failed to drop columns', 'error');
            }
        })
        .catch(error => {
            console.error('AJAX error:', error); // Debug log
            showDropLoading(false);
            showDropMessage('Error dropping columns: ' + error.message, 'error');
        });
    }
    
    // Function to handle checkbox change events (instant dropping)
    function handleCheckboxChange(event) {
        const checkbox = event.target;
        const columnName = checkbox.value;
        const isChecked = checkbox.checked;
        
        console.log('Checkbox changed:', columnName, 'checked:', isChecked); // Debug log
        
        if (isChecked) {
            // Column is checked - drop it immediately
            dropColumns([columnName]);
        }
        // If unchecked, we don't need to do anything (column already dropped)
    }
    
    // Function to show/hide drop loading
    function showDropLoading(show) {
        if (show) {
            dropLoading.style.display = 'block';
            // Disable all checkboxes during loading
            const checkboxes = document.querySelectorAll('input[name="columns_to_drop"]');
            checkboxes.forEach(cb => cb.disabled = true);
        } else {
            dropLoading.style.display = 'none';
            // Re-enable all checkboxes
            const checkboxes = document.querySelectorAll('input[name="columns_to_drop"]');
            checkboxes.forEach(cb => cb.disabled = false);
        }
    }
    
    // Function to update column checkboxes with instant dropping
    function updateColumnCheckboxes(remainingColumns) {
        console.log('Updating checkboxes with columns:', remainingColumns); // Debug log
        
        columnsCheckboxGrid.innerHTML = '';
        remainingColumns.forEach(col => {
            // Filter out unnamed columns
            if (!col.startsWith('Unnamed:')) {
                const label = document.createElement('label');
                label.className = 'column-checkbox';
                label.innerHTML = `
                    <input type="checkbox" name="columns_to_drop" value="${col}">
                    ${col}
                `;
                
                // Add instant dropping event listener
                const checkbox = label.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', handleCheckboxChange);
                
                columnsCheckboxGrid.appendChild(label);
            }
        });
    }
    
    // Function to update row count in header
    function updateRowCount(rowCount) {
        const header = document.querySelector('.card h3');
        if (header && header.textContent.includes('Complete Cleaned Data')) {
            header.textContent = `ğŸ“‹ Complete Cleaned Data (${rowCount} rows)`;
        }
    }
    
    // Function to update visualization dropdowns with current columns
    function updateVisualizationDropdowns(allColumns, numericColumns) {
        console.log('Updating visualization dropdowns:', allColumns, numericColumns); // Debug log
        
        const xColumnSelect = document.getElementById('x-column-select');
        const yColumnSelect = document.getElementById('y-column-select');
        const colorColumnSelect = document.getElementById('color-column-select');
        
        // Update X column dropdown
        if (xColumnSelect) {
            updateDropdownOptions(xColumnSelect, allColumns);
        }
        
        // Update Y column dropdown
        if (yColumnSelect) {
            updateDropdownOptions(yColumnSelect, numericColumns);
        }
        
        // Update Color column dropdown
        if (colorColumnSelect) {
            updateDropdownOptions(colorColumnSelect, allColumns);
        }
    }
    
    // Helper function to update dropdown options
    function updateDropdownOptions(selectElement, columns) {
        // Store current selection
        const currentValue = selectElement.value;
        
        // Clear existing options (except the first one which is auto/placeholder)
        selectElement.innerHTML = '';
        
        // Add auto/placeholder option
        if (selectElement.id === 'y-column-select' || selectElement.id === 'color-column-select') {
            const noneOption = document.createElement('option');
            noneOption.value = '';
            noneOption.textContent = 'None';
            selectElement.appendChild(noneOption);
        } else {
            const autoOption = document.createElement('option');
            autoOption.value = '';
            autoOption.textContent = 'Auto-select';
            selectElement.appendChild(autoOption);
        }
        
        // Add column options
        columns.forEach(column => {
            const option = document.createElement('option');
            option.value = column;
            option.textContent = column;
            selectElement.appendChild(option);
        });
        
        // Restore selection if it still exists
        if (currentValue && columns.includes(currentValue)) {
            selectElement.value = currentValue;
        } else {
            selectElement.value = '';
        }
    }
    
    // Function to update other sections that use column lists
    function updateOtherSections(allColumns, numericColumns) {
        console.log('Updating other sections with columns:', allColumns, numericColumns); // Debug log
        
        // Update ML form target column dropdown
        const targetColumnSelect = document.querySelector('select[name="target_column"]');
        if (targetColumnSelect) {
            updateDropdownOptions(targetColumnSelect, allColumns);
        }
        
        // Update ML form feature columns checkboxes
        const featureCheckboxes = document.querySelectorAll('input[name="feature_columns"]');
        featureCheckboxes.forEach(checkbox => {
            const label = checkbox.parentNode;
            if (allColumns.includes(checkbox.value)) {
                // Column still exists, ensure checkbox is visible
                label.style.display = 'flex';
            } else {
                // Column was dropped, remove checkbox
                label.remove();
            }
        });
        
        // Add checkboxes for new columns
        const featureContainer = document.querySelector('.checkbox-grid');
        if (featureContainer && featureContainer.querySelector('input[name="feature_columns"]')) {
            allColumns.forEach(column => {
                const existingCheckbox = document.querySelector(`input[name="feature_columns"][value="${column}"]`);
                if (!existingCheckbox && !column.startsWith('Unnamed:')) {
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="checkbox" name="feature_columns" value="${column}">
                        ${column}
                    `;
                    featureContainer.appendChild(label);
                }
            });
        }
        
        // Update 3D sculpture column dropdown
        const sculptureColumnSelect = document.querySelector('select[name="3d_column"]');
        if (sculptureColumnSelect) {
            updateDropdownOptions(sculptureColumnSelect, numericColumns);
        }
        
        // Update AI insights date column dropdown
        const dateColumnSelect = document.querySelector('select[name="date_column"]');
        if (dateColumnSelect) {
            // For date columns, we want to show all columns but highlight potential date columns
            updateDropdownOptions(dateColumnSelect, allColumns);
        }
    }
    
    // Function to initialize visualization dropdowns from server data
    function initializeVisualizationDropdowns() {
        console.log('Initializing visualization dropdowns from server data'); // Debug log
        
        // Get columns from the server-side template context if available
        const columnsData = document.querySelector('[data-columns]');
        const numericColumnsData = document.querySelector('[data-numeric-columns]');
        
        if (columnsData && numericColumnsData) {
            try {
                const allColumns = JSON.parse(columnsData.getAttribute('data-columns'));
                const numericColumns = JSON.parse(numericColumnsData.getAttribute('data-numeric-columns'));
                
                console.log('Server data loaded:', { allColumns, numericColumns }); // Debug log
                
                updateVisualizationDropdowns(allColumns, numericColumns);
            } catch (e) {
                console.error('Error parsing server data:', e); // Debug log
            }
        } else {
            console.log('Server column data not found, checking for existing dropdowns'); // Debug log
            
            // Fallback: populate from existing dropdowns if they already have options
            const xColumnSelect = document.getElementById('x-column-select');
            const yColumnSelect = document.getElementById('y-column-select');
            const colorColumnSelect = document.getElementById('color-column-select');
            
            if (xColumnSelect && xColumnSelect.options.length > 1) {
                // Dropdowns already populated, no action needed
                console.log('Dropdowns already populated'); // Debug log
            } else {
                console.log('No column data available for initialization'); // Debug log
            }
        }
    }

    
    // Function to show drop messages
    function showDropMessage(message, type) {
        // Remove existing messages
        const existingMessages = document.querySelectorAll('.drop-message');
        existingMessages.forEach(msg => msg.remove());
        
        // Create message element
        const messageDiv = document.createElement('div');
        messageDiv.className = `drop-message ${type === 'success' ? 'drop-success' : 'drop-error'}`;
        messageDiv.style.cssText = 'padding: 15px; margin: 10px 0; border-radius: 6px; font-weight: bold;';
        messageDiv.textContent = message;
        
        // Insert after the drop section
        const dropSection = document.querySelector('.column-drop-section');
        if (dropSection) {
            dropSection.parentNode.insertBefore(messageDiv, dropSection.nextSibling);
        }
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 5000);
    }
    
    // Add instant dropping event listeners to initial checkboxes
    function addInstantListeners() {
        console.log('Adding event listeners to checkboxes'); // Debug log
        const checkboxes = document.querySelectorAll('input[name="columns_to_drop"]');
        console.log('Found', checkboxes.length, 'checkboxes'); // Debug log
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handleCheckboxChange);
        });
    }
    
    // Initialize event listeners when DOM is ready
    addInstantListeners();

    // Initialize visualization dropdowns on page load
    initializeVisualizationDropdowns();

    // Re-add listeners after any AJAX updates
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                // Check if checkboxes were added
                const newCheckboxes = document.querySelectorAll('input[name="columns_to_drop"]');
                if (newCheckboxes.length > 0) {
                    console.log('Re-adding listeners after DOM update'); // Debug log
                    addInstantListeners();
                }
            }
        });
    });
    
    // Start observing the checkbox grid for changes
    if (columnsCheckboxGrid) {
        observer.observe(columnsCheckboxGrid, {
            childList: true,
            subtree: true
        });
    }
});
</script>

{% endblock %}
